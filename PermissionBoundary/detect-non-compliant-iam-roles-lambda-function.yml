AWSTemplateFormatVersion: 2010-09-09
Description: >-
  This stack creates a Lambda function that will apply
  a permission boundary policy to quarantine a non-compliant role
  when a CloudWatch rule is triggered by an API call (either
  iam:CreateRole or iam:UpdateAssumeRolePolicy) that created
  the non-compliant IAM role.
Parameters:
  LambdaRoleName:
    Type: String
  LambdaFunctionName:
    Type: String
  S3BucketName:
    Type: String
  S3Key:
    Type: String
Resources:
  LambdaRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Ref LambdaRoleName
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: 'Allow'
            Principal:
              Service:
                - 'lambda.amazonaws.com' 
            Action: 
              - 'sts:AssumeRole'
      Path: '/'
      Policies:
        -
          PolicyName: 'AllowedPermissions'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: 'AllowIamPermission'
                Effect: 'Allow'
                Action: 
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                  - 'iam:List*'
                  - 'iam:Get*'
                  - 'iam:Put*'
                Resource: '*'
              - Sid: 'AllowS3GetObject'
                Effect: 'Allow'
                Action: 
                  - 's3:GetObject'
                Resource: !Sub 'arn:aws:s3:::${S3BucketName}/*'
  LambdaFunction:
    Type: 'AWS::Lambda::Function'
    DependsOn: LambdaRole
    Properties:
      Description: >-
        This Lambda function will attach a permission boundary
        policy to a non-compliant role when a CloudWatch rule is
        triggered by an API call (either iam:CreateRole or 
        iam:UpdateAssumeRolePolicy) that created the non-compliant IAM role.
      FunctionName: !Ref LambdaFunctionName
      Handler: !Sub '${LambdaFunctionName}.lambda_handler'
      Role: !Sub 'arn:aws:iam::${AWS::AccountId}:role/${LambdaRoleName}'
      Code: 
        S3Bucket: !Ref S3BucketName
        S3Key: !Ref S3Key
      Runtime: 'python3.7'
      Timeout: 60
Outputs:
  LambdaRoleArn:
    Value: !GetAtt LambdaRole.Arn
  LambdaRoleId:
    Value: !GetAtt LambdaRole.RoleId
  LambdaFunctionArn:
    Value: !GetAtt LambdaFunction.Arn
